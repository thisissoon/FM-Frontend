#
# CircleCI Configuration
#

# Machine Settings

machine:
  services:
    - docker
  node:
    version: 6
  environment:
    REPO: gcr.io/soon-fm-production/web
    TAG: $(sed 's/master/latest/;s/\//\-/' <<<$CIRCLE_BRANCH)
    PROJECT_NAME: soon-fm-production
    GCLOUD_COMPUTE_ZONE: europe-west1-c

# Dependencies

dependencies:
  pre:
    - npm install -g grunt-cli bower protractor
    - webdriver-manager update
    - docker login -u $DOCKER_USER -p $DOCKER_PASS -e $DOCKER_EMAIL $DOCKER_REGISTRY
  override:
    - npm -d install
  post:
    - echo $GCLOUD_SERVICE_AUTH | base64 --decode -i > ${HOME}/account-auth.json
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update kubectl
    - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/account-auth.json
    - sudo /opt/google-cloud-sdk/bin/gcloud config set project ${PROJECT_NAME}
    - sudo /opt/google-cloud-sdk/bin/gcloud config set compute/zone ${GCLOUD_COMPUTE_ZONE}

# Test Commands

test:
  pre:
    - chmod +x ./tests/e2e/saucelabs.sh
  override:
    - grunt test:development
    - grunt test
    # - ./tests/e2e/saucelabs.sh
  post:
    - ./node_modules/coveralls/bin/coveralls.js < coverage/lcov.info

# Deployment

deployment:
  prod:
    branch: master
    commands:
      - grunt build --env production
      - docker build -t $REPO:$CIRCLE_SHA1 .
      - docker tag $REPO:$CIRCLE_SHA1 $REPO:latest
      - sudo /opt/google-cloud-sdk/bin/gcloud --quiet container clusters get-credentials production
      - sudo /opt/google-cloud-sdk/bin/gcloud --quiet config set container/cluster production
      - sudo /opt/google-cloud-sdk/bin/gcloud docker -- push $REPO:$CIRCLE_SHA1
      - sudo /opt/google-cloud-sdk/bin/gcloud docker -- push $REPO:latest
      - sudo chown -R $USER /home/ubuntu/.config
      - sudo chown -R $USER /home/ubuntu/.kube
      - cat k8s.yml | sed "s#\$TAG#${CIRCLE_SHA1}#g" | kubectl apply -f -
